{% extends "base.html" %}
{% load static i18n %}
{% block title %}Search Results{% endblock %}
{% block css %}
{{ block.super }}
<link href="{% static 'genoverse/css/tooltips.css' %}" rel="stylesheet" ></link>
<style>
g.tick > text {
    font-size: 2em;
}

svg > g > text {
    font-size: 2em;
}
</style>
{% endblock %}
{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
<script type="text/javascript" src="{% static 'genoverse/js/genoverse.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/index.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/state.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/genoverse.js' %}"></script>
<script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.2"></script>
{% endblock %}
{% block content %}
    <div class="flex flex-row">
        <div id="filter-bar" class="grid grid-cols-1">
            <div id="facets" class="w-60">
                {% for facet in facets.all %}
                    <fieldset id="facetfield">
                        <legend>{{ facet.name }}</legend>
                        <div class="flex flex-row flex-wrap gap-1">
                            {% for value in facet.values.all %}
                            <div>
                                <input type="checkbox" id="{{ value.id }}" name="{{ facet.name }}"></input>
                                <label for="{{ value.id }}">{{ value.value }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </fieldset>
                {% endfor %}
            </div>
            <div class=""></div>
        </div>
        <div id="main-content" class="flex-initial w-4/5">
            <div class="flex search-wrapper">
                <div class="text-2xl m-2 font-bold self-end align-baseline">Results</div>
                <div class="flex-grow"></div>
                <form action="{% url 'search:results' %}" method="get" class="search">
                    {{ form }}
                    <input type="submit" value="Search Again" class="search-button self-end">
                </form>
            </div>
            {% if loc_search.location %}
            <div id="loc-header" class="text-2xl font-bold my-4">{{ loc_search.location.chromo }}: {{ loc_search.location.range.lower }}-{{ loc_search.location.range.upper }}</div>
            <div class="p-2" id="genoverse"></div>
            {% endif %}
            <div id="plot"></div>
            {% with all_dhss=dhss.all %}
            {% if all_dhss|length > 0 %}
            <div class="my-4">
                <div class="text-xl font-bold">DNase I Hypersensitive Sites</div>
                {% include "search/partials/_dnaregion.html" with regions=all_dhss %}
            </div>
            {% endif %}
            {% endwith %}
        </div>
    </div>
{% endblock %}
{% block inline_javascript %}
    <script>
        const STATE_LOCATION = "location";
        const STATE_QUERY_RESULTS = "query-results";
        let state = new State([STATE_LOCATION, STATE_QUERY_RESULTS]);

        // Update the chromosome location at the top of the page
        state.addCallback(STATE_LOCATION, (state, key) => {
            let location = state[key];

            rc(g("loc-header"), t(`chr${location.chr}: ${location.start}-${location.end}`))
        });

        state.addCallback(STATE_QUERY_RESULTS, (state, key) => {

        })

        const _ul = function(_state, key) {
            if (key !== STATE_LOCATION) { return; }
            state.updateSharedState(key, _state[key]);
        }

        const fieldSet = g("facetfield");
        const facetCheckboxes = fieldSet.querySelectorAll("input[type=checkbox]");
        facetCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change",  _.throttle(event => {
                enabledFacets = Array.from(facetCheckboxes) // Convert checkboxes to an array to use filter and map.
                                     .filter(i => i.checked) // Use Array.filter to remove unchecked checkboxes.
                                     .map(i => `facet=${i.id}`)
                                     .join('&')
                searchURL = `{% url 'search:results' %}?query={{ query }}${enabledFacets !== '' ? '&' + enabledFacets : ''}`;
                window.history.pushState({}, document.title, searchURL);
                fetch(`${searchURL}&accept=application/json`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Request Failed: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        g("dnaregion").replaceWith(dhsTable(data["dhss"], "No DHSs Found"));
                    })
                    .catch((error) => {
                        console.error(error);
                    });

        }, 500, { 'leading': true }))
    })

        // Show the plot
        function geneDHSPlot(data) {
            let dhssWithTargets = data.filter(dhs => dhs.effects.length > 0 && dhs.effects.filter(effect => effect.targets.length > 0).length > 0);
            let dwtSet = new Set(dhssWithTargets);
            let targets = dhssWithTargets.flatMap(dhs => dhs.effects.flatMap(effect => effect.target_assemblies.map(assembly => {
                assembly["effect_size"] = effect.effect_size;
                assembly["label"] = dhs.label;
                return assembly
            })))

            if (targets.length == 0) {
                return e("span");
            }

            let plot = Plot.plot({
                height: 480,
                padding: 0,
                marginLeft: 50,
                marginTop: 50,
                color: {
                    range: ["#f0e442", "#56b4e9"],
                    interpolate: "hcl"
                },
                x: {
                    axis: "top",
                    round: false,
                    label: "DHS"
                },
                y: {
                    round: false,
                    label: "Gene",
                    tickPadding: 6,
                    tickRotate: -90,
                },
                marks: [
                    Plot.cell(
                        targets,
                        {
                            x: "label",
                            y: "name",
                            fill: "effect_size",
                            title: "effect_size",
                            rx: 8,
                            ry: 8
                        }
                    ),
                    Plot.text(
                        targets,
                        {
                            x: "label",
                            y: "name",
                            text: d => d.effect_size?.toFixed(3),
                            title: "effect_size",
                        }
                    )
                ]
            })

            return plot;
        }
        function applyPlot(state, key) {
            if (key !== "dhs-effect-data" && key !== "location") { return; }
            let dhss = state["dhs-effect-data"];
            let location = state["location"];

            if (!dhss || !location) { return; }

            data = location ? dhss.filter(dhs => location.chr === dhs.chr && dhs.start >= location.start && dhs.end <= location.end) : dhss;

            let genePlot = g("plot");
            if (genePlot) {
                let plotNode = geneDHSPlot(data);
                rc(genePlot, plotNode);
            }
        }

        {% if loc_search.location %}
        // Show the browser
        let browser = new CEGSGenoverse({
            container : '#genoverse', // Where to inject Genoverse (css/jQuery selector/DOM element)
            // If no genome supplied, it must have at least chromosomeSize, e.g.:
            // chromosomeSize : 249250621, // chromosome 1, human
            genome    : '{{ loc_search.assembly }}', // see js/genomes/
            assembly  : '{{ loc_search.assembly }}',
            chr       : "{{ loc_search.location.chromo }}".replace("chr", ""),
            start     : {{ loc_search.location.range.lower }},
            end       : {{ loc_search.location.range.upper }},
            plugins   : [[ 'karyotype', { showAssembly: true }], 'trackControls', 'tooltips' ],
            useHash   : true,
            hideEmptyTracks: false,
            sharedStateCallbacks: [_ul, applyPlot],
            width: 1200,
            tracks: [
                Genoverse.Track.Scaleline.extend({ strand: false }),
                Genoverse.Track.Scalebar,
                Genoverse.Track.DHS.Effects.extend({children: [Genoverse.Track.Gene.extend({ legend: false })]}),
            ]
        });
        {% endif %}
    </script>
{% endblock %}
