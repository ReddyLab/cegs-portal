{% extends "base.html" %}
{% load static i18n %}
{% load waffle_tags %}
{% block title %}Search Results{% endblock %}
{% block css %}
{{ block.super }}
<link href="{% static 'genoverse/css/tooltips.css' %}" rel="stylesheet" ></link>
<style>
g.tick > text {
    font-size: 2em;
}

svg > g > text {
    font-size: 2em;
}
</style>
{% endblock %}
{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
<script type="text/javascript" src="{% static 'genoverse/js/genoverse.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/index.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/state.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/genoverse.js' %}"></script>
<script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.2"></script>
{% endblock %}
{% block content %}
    <div class="flex flex-row">
        <div id="filter-bar" class="grid grid-cols-1">
            <div id="facets" class="w-60">
                {% for facet in facets.all %}
                    <fieldset id="facetfield">
                        <legend>{{ facet.name }}</legend>
                        <div class="flex flex-row flex-wrap gap-1">
                            {% for value in facet.values.all %}
                            <div>
                                <input type="checkbox" id="{{ value.id }}" name="{{ facet.name }}"></input>
                                <label for="{{ value.id }}">{{ value.value }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </fieldset>
                {% endfor %}
            </div>
            <div class=""></div>
        </div>
        <div id="main-content" class="flex-initial w-4/5">
            <div class="flex search-wrapper">
                <div class="text-2xl m-2 font-bold self-end align-baseline">Results</div>
                <div class="flex-grow"></div>
                <form action="{% url 'search:results' %}" method="get" class="search">
                    {{ form }}
                    <input type="submit" value="Search Again" class="search-button self-end">
                </form>
            </div>
            {% if loc_search.location %}
            <div id="loc-header" class="text-2xl font-bold my-4">{{ loc_search.location.chromo }}: {{ loc_search.location.range.lower }}-{{ loc_search.location.range.upper }}</div>
            <div class="p-2" id="genoverse"></div>
            {% endif %}
            {% switch "effect_plot" %}
            <div id="plot"></div>
            {% endswitch %}
            {% if dhss|length > 0 %}
            <div class="my-4">
                <div class="text-xl font-bold">DNase I Hypersensitive Sites</div>
                {% include "search/v1/partials/_dnaregion.html" with regions=dhss.object_list %}
            </div>
            <div id="dhs_pagination" class="pagination">
                <span class="step-links">
                    {% if dhss.has_previous %}
                        <a id="dhs_first_link" href="?dhs_page=1">&laquo; first</a>
                        <a id="dhs_prev_link" href="?dhs_page={{ dhss.previous_page_number }}">previous</a>
                    {% endif %}

                    <span class="current">
                        Page {{ dhss.number }} of {{ dhss.paginator.num_pages }}
                    </span>

                    {% if dhss.has_next %}
                        <a id="dhs_next_link" href="?dhs_page={{ dhss.next_page_number }}">next</a>
                        <a id="dhs_last_link" href="?dhs_page={{ dhss.paginator.num_pages }}">last &raquo;</a>
                    {% endif %}
                </span>
            </div>
            {% else %}
                <div id="dnaregion">No DHSs Found</div>
                <div id="dhs_pagination" style="display:none;"></div>
            {% endif %}
        </div>
    </div>
{% endblock %}
{% block inline_javascript %}
    <script>
        const STATE_LOCATION = "location";
        const STATE_QUERY_RESULTS = "query-results";
        const STATE_FACETS = "facets"
        let state = new State([STATE_LOCATION, STATE_QUERY_RESULTS, STATE_FACETS]);
        state.updateSharedState(STATE_LOCATION, {
            chr: "{{ loc_search.location.chromo }}",
            start: {{ loc_search.location.range.lower }},
            end: {{ loc_search.location.range.upper }}
        }
        );
        state.updateSharedState(STATE_FACETS, []);

        // Update the chromosome location at the top of the page
        state.addCallback(STATE_LOCATION, (state, key) => {
            let location = state[key];

            rc(g("loc-header"), t(`chr${location.chr}: ${location.start}-${location.end}`))

            genDataPages(location.chr, location.start, location.end, 1)();
        });

        state.addCallback(STATE_FACETS, _.throttle(
            (state, key) => {
                window.history.pushState({}, document.title, searchURL(state[key]));

                let location = state[STATE_LOCATION];

                genDataPages(location.chr, location.start, location.end, 1, state[STATE_FACETS])();
            },
            500,
            { 'leading': true })
        )

        const _ul = function(_state, key) {
            if (key !== STATE_LOCATION) { return; }
            state.updateSharedState(key, _state[key]);
        }

        let initialLocation = state.getSharedState(STATE_LOCATION);

        let genDataPages = function(chromo, start, end, page, facets = []) {
            return dataPages(
                page,
                _ => regionURL(chromo, start, end, facets),
                regionTable,
                emptyRegionTable,
                region => true,
                "No DHSs Found",
                "dnaregion",
                "dhs_pagination",
                "dhs",
                "page"
            )
        }

        let getPages = genDataPages(initialLocation.chr, initialLocation.start, initialLocation.end, 1)

        {% if dhss.has_previous %}
        pageLink("dhs_first_link", 1, getPages);
        pageLink("dhs_prev_link", {{ dhss.previous_page_number }}, getPages);
        {% endif %}
        {% if dhss.has_next %}
        pageLink("dhs_next_link", {{ dhss.next_page_number }}, getPages);
        pageLink("dhs_last_link", {{ dhss.paginator.num_pages }}, getPages);
        {% endif %}

        const fieldSet = g("facetfield");
        const facetCheckboxes = fieldSet.querySelectorAll("input[type=checkbox]");

        let searchURL = function(facets) {
            enabledFacets = facets.map(id => `facet=${id}`)
                                  .join('&')
            return `{% url 'search:results' %}?query={{ query }}${enabledFacets !== '' ? '&' + enabledFacets : ''}`;
        }

        let regionURL = function(chromosome, start, end, facets=[]) {
            enabledFacets = facets.map(id => `facet=${id}`)
                                  .join('&')
            return `/search/regionloc/${chromosome}/${start}/${end}?assembly={{ loc_search.assembly }}&search_type=overlap&accept=application/json&region_type=dhs${enabledFacets !== '' ? '&' + enabledFacets : ''}`
        }

        facetCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", _ => {
                checkedFacets = Array.from(facetCheckboxes) // Convert checkboxes to an array to use filter and map.
                                     .filter(i => i.checked) // Use Array.filter to remove unchecked checkboxes.
                                     .map(i => i.id)
                state.updateSharedState(STATE_FACETS, checkedFacets);
            });
        });

        {% switch "effect_plot" %}
        // Show the plot
        function geneDHSPlot(data) {
            let dhssWithTargets = data.filter(dhs => dhs.effects.length > 0 && dhs.effects.filter(effect => effect.targets.length > 0).length > 0);
            let dwtSet = new Set(dhssWithTargets);
            let targets = dhssWithTargets.flatMap(dhs => dhs.effects.flatMap(effect => effect.target_assemblies.map(assembly => {
                assembly["effect_size"] = effect.effect_size;
                assembly["label"] = dhs.label;
                return assembly
            })))

            if (targets.length == 0) {
                return e("span");
            }

            let plot = Plot.plot({
                height: 480,
                padding: 0,
                marginLeft: 50,
                marginTop: 50,
                color: {
                    range: ["#f0e442", "#56b4e9"],
                    interpolate: "hcl"
                },
                x: {
                    axis: "top",
                    round: false,
                    label: "DHS"
                },
                y: {
                    round: false,
                    label: "Gene",
                    tickPadding: 6,
                    tickRotate: -90,
                },
                marks: [
                    Plot.cell(
                        targets,
                        {
                            x: "label",
                            y: "name",
                            fill: "effect_size",
                            title: "effect_size",
                            rx: 8,
                            ry: 8
                        }
                    ),
                    Plot.text(
                        targets,
                        {
                            x: "label",
                            y: "name",
                            text: d => d.effect_size?.toFixed(3),
                            title: "effect_size",
                        }
                    )
                ]
            })

            return plot;
        }
        function applyPlot(state, key) {
            if (key !== "dhs-effect-data" && key !== "location") { return; }
            let dhss = state["dhs-effect-data"];
            let location = state["location"];

            if (!dhss || !location) { return; }

            data = location ? dhss.filter(dhs => location.chr === dhs.chr && dhs.start >= location.start && dhs.end <= location.end) : dhss;

            let genePlot = g("plot");
            if (genePlot) {
                let plotNode = geneDHSPlot(data);
                rc(genePlot, plotNode);
            }
        }
        {% endswitch %}

        {% if loc_search.location %}
        // Show the browser
        let browser = new CEGSGenoverse({
            container : '#genoverse', // Where to inject Genoverse (css/jQuery selector/DOM element)
            // If no genome supplied, it must have at least chromosomeSize, e.g.:
            // chromosomeSize : 249250621, // chromosome 1, human
            genome    : '{{ loc_search.assembly }}', // see js/genomes/
            assembly  : '{{ loc_search.assembly }}',
            chr       : "{{ loc_search.location.chromo }}".replace("chr", ""),
            start     : {{ loc_search.location.range.lower }},
            end       : {{ loc_search.location.range.upper }},
            plugins   : [[ 'karyotype', { showAssembly: true }], 'trackControls', 'tooltips' ],
            useHash   : true,
            hideEmptyTracks: false,
            sharedStateCallbacks: [_ul{% switch "effect_plot" %}, applyPlot{% endswitch %}],
            width: 1200,
            tracks: [
                Genoverse.Track.Scaleline.extend({ strand: false }),
                Genoverse.Track.Scalebar,
                Genoverse.Track.DHS.Effects.extend({children: [Genoverse.Track.Gene]}),
            ]
        });
        {% endif %}
    </script>
{% endblock %}
