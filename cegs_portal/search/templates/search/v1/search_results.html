{% extends "base.html" %}
{% load static i18n %}
{% load waffle_tags %}
{% block title %}Search Results{% endblock %}
{% block css %}
{{ block.super }}
<link href="{% static 'genoverse/css/tooltips.css' %}" rel="stylesheet" ></link>
<style>
g.tick > text {
    font-size: 2em;
}

svg > g > text {
    font-size: 2em;
}
</style>
{% endblock %}
{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
<script type="text/javascript" src="{% static 'genoverse/js/genoverse.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/genoverse.js' %}"></script>
<script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.2"></script>
{% endblock %}
{% block content %}
    <div class="flex flex-row">
        <div id="filter-bar" class="grid grid-cols-1">
            <div id="facets" class="w-60">
                {% for facet in facets.all %}
                    <fieldset name="facetfield">
                        <legend class="font-bold">{{ facet.name }}</legend>
                        <div class="flex flex-row flex-wrap gap-1">
                            {% for value in facet.values.all %}
                            <div>
                                <input type="checkbox" id="{{ value.id }}" name="{{ facet.name }}"{% if value.id in facets_query %} checked="" {% endif %}></input>
                                <label for="{{ value.id }}">{{ value.value }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </fieldset>
                {% endfor %}
            </div>
        </div>
        <div id="main-content" class="flex-initial">
            <div class="flex search-wrapper">
                <div class="text-2xl m-2 font-bold self-end align-baseline">Results</div>
                <div class="flex-grow"></div>
                <form action="{% url 'search:results' %}" method="get" class="search">
                    {{ form }}
                    <input type="submit" value="Search Again" class="search-button self-end">
                </form>
            </div>
            {% if "IGNORE_LOC" in warnings %}
            <div class="text-red-700">The location in the query has been ignored.</div>
            <div class="text-red-700">Queries can include either gene IDs/names or locations. If a query contains both, the first type encountered is used and the other type is ignored.</div>
            {% endif %}
            {% if "TOO_MANY_LOCS" in warnings %}
            <div class="text-red-700">The query contains more than one location; only the first location is used.</div>
            {% endif %}
            {% if "IGNORE_TERMS" in warnings %}
            <div class="text-red-700">Gene IDs or names in the query were ignored</div>
            <div class="text-red-700">Queries can include either gene IDs/names or locations. If a query contains both, the first type encountered is used and the other type is ignored.</div>
            {% endif %}
            {% if location %}
            <div id="loc-header" class="text-2xl font-bold my-4">{{ location.chromo }}: {{ location.range.lower }}-{{ location.range.upper }}</div>
            {% endif %}
            {% if location and assembly %}
            <div class="p-2" id="genoverse"></div>
            {% endif %}
            {% switch "effect_plot" %}
            <div id="plot"></div>
            {% endswitch %}
            {% include "search/v1/partials/_paged_nav.html" with data=features name="Genome Features" no_data="No DNA Features Found" container_id="dnafeature" prefix="feature" page_query="feature_page" table="search/v1/partials/_features.html" %}
        </div>
    </div>
{% endblock %}
{% block inline_javascript %}
    <script type="module">
        import { e, g, rc, t } from "{% static 'search/js/dom.js' %}";
        import { State } from "{% static 'search/js/state.js' %}";
        import { dataPages, featureTable, emptyFeatureTable, pageLink } from "{% static 'search/js/tables.js' %}"

        let searchURL = function(facets) {
            let enabledFacets = facets.map(id => `facet=${id}`)
                                  .join('&')
            return `{% url 'search:results' %}?query={{ query }}${enabledFacets !== '' ? '&' + enabledFacets : ''}`;
        }

        const STATE_LOCATION = "location";
        const STATE_FACETS = "facets"
        const STATE_DHS_EFFECT = "dhs-effect-data"
        let state = new State({
            [STATE_LOCATION]: {
                chr: "{{ location.chromo }}",
                start: {{ location.range.lower }},
                end: {{ location.range.upper }}
            },
            [STATE_FACETS]: [],
            [STATE_DHS_EFFECT]: null
        });

        const _ul = function(_state, key) {
            if (key !== STATE_LOCATION) { return; }
            state.updateSharedState(key, _state[key]);
        }

        let initialLocation = state.getSharedState(STATE_LOCATION);

        let featureURL = function(chromosome, start, end, facets=[]) {
            let enabledFacets = facets.map(id => `facet=${id}`)
                                  .join('&');
            return `/search/featureloc/${chromosome}/${start}/${end}?assembly={{ assembly }}&search_type=overlap&paginate=true&accept=application/json${enabledFacets !== '' ? '&' + enabledFacets : ''}`;
        }

        {% include "search/v1/partials/_paged_nav_js.html" with data=features no_data="No DNA Features Found" container_id="dnafeature" prefix="feature" page_query="page" url_function="_ => featureURL(chromo, start, end, facets)" %}

        const facetCheckboxes = document.querySelectorAll("[name=facetfield] input[type=checkbox]");

        const updateFacetState = function() {
            let checkedFacets = Array.from(facetCheckboxes) // Convert checkboxes to an array to use filter and map.
                                     .filter(i => i.checked) // Use Array.filter to remove unchecked checkboxes.
                                     .map(i => i.id)
                state.updateSharedState(STATE_FACETS, checkedFacets);
        }
        facetCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", _ => {
                updateFacetState();
            });
        });

        updateFacetState();

        // Update the chromosome location at the top of the page
        state.addCallback(STATE_LOCATION, (state, key) => {
            let location = state[key];

            rc(g("loc-header"), t(`chr${location.chr}: ${location.start}-${location.end}`));

            __genDataPages(location.chr, location.start, location.end, 1,  state[STATE_FACETS])();
        });

        state.addCallback(STATE_FACETS, _.throttle(
            (state, key) => {
                window.history.pushState({}, document.title, searchURL(state[key]));

                let location = state[STATE_LOCATION];

                __genDataPages(location.chr, location.start, location.end, 1, state[STATE_FACETS])();
            },
            500,
            { 'leading': true })
        );

        {% switch "effect_plot" %}
        // Show the plot
        function geneDHSPlot(data) {
            let dhssWithTargets = data.filter(dhs => dhs.source_for.length > 0 && dhs.source_for.filter(effect => effect.targets.length > 0).length > 0);
            let dwtSet = new Set(dhssWithTargets);
            let targets = dhssWithTargets.flatMap(dhs => dhs.source_for.flatMap(effect => effect.targets.map(assembly => {
                assembly["effect_size"] = effect.effect_size;
                assembly["label"] = dhs.label;
                return assembly
            })))

            if (targets.length == 0) {
                return e("span");
            }

            let plot = Plot.plot({
                height: 480,
                padding: 0,
                marginLeft: 50,
                marginTop: 50,
                color: {
                    range: ["#f0e442", "#56b4e9"],
                    interpolate: "hcl"
                },
                x: {
                    axis: "top",
                    round: false,
                    label: "DHS"
                },
                y: {
                    round: false,
                    label: "Gene",
                    tickPadding: 6,
                    tickRotate: -90,
                },
                marks: [
                    Plot.cell(
                        targets,
                        {
                            x: "label",
                            y: "name",
                            fill: "effect_size",
                            title: "effect_size",
                            rx: 8,
                            ry: 8
                        }
                    ),
                    Plot.text(
                        targets,
                        {
                            x: "label",
                            y: "name",
                            text: d => d.effect_size?.toFixed(3),
                            title: "effect_size",
                        }
                    )
                ]
            })

            return plot;
        }
        function applyPlot(state, key) {
            if (key !== STATE_DHS_EFFECT && key !== STATE_LOCATION) { return; }
            let dhss = state[STATE_DHS_EFFECT];
            let location = state[STATE_LOCATION];

            if (!dhss || !location) { return; }

            data = location ? dhss.filter(dhs => location.chr === dhs.chr && dhs.start >= location.start && dhs.end <= location.end) : dhss;

            let genePlot = g("plot");
            if (genePlot) {
                let plotNode = geneDHSPlot(data);
                rc(genePlot, plotNode);
            }
        }
        {% endswitch %}

        {% if location and assembly %}
        // Show the browser
        let browser = new CEGSGenoverse({
            container : '#genoverse', // Where to inject Genoverse (css/jQuery selector/DOM element)
            // If no genome supplied, it must have at least chromosomeSize, e.g.:
            // chromosomeSize : 249250621, // chromosome 1, human
            genome    : '{{ assembly }}', // see js/genomes/
            assembly  : '{{ assembly }}',
            chr       : "{{ location.chromo }}".replace("chr", ""),
            start     : {{ location.range.lower }},
            end       : {{ location.range.upper }},
            plugins   : [[ 'karyotype', { showAssembly: true }], 'trackControls', 'tooltips' ],
            useHash   : true,
            hideEmptyTracks: false,
            sharedStateCallbacks: [{% if search_type == "LOCATION" %}_ul{% endif %}{% switch "effect_plot" %}{% if search_type == "LOCATION" %}, {% endif %}applyPlot{% endswitch %}],
            width: 1200,
            tracks: [
                Genoverse.Track.Scaleline.extend({ strand: false }),
                Genoverse.Track.Scalebar,
                Genoverse.Track.DHS.Effects.extend({children: [Genoverse.Track.Gene]}),
            ]
        });
        {% endif %}
    </script>
{% endblock %}
