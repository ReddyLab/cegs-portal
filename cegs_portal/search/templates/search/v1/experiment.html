{% extends "base.html" %} {% load static i18n %} {% block css %} {{ block.super }}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<link href="{% static 'css/nouislider.min.css' %}" rel="stylesheet" />
<!-- This CSS modifies the range slider look -->
<style>
    .noUi-horizontal {
        height: 10px;
    }

    .noUi-horizontal .noUi-handle {
        width: 20px;
        height: 20px;
    }

    .noUi-handle {
        border-radius: 10px;
    }

    .noUi-handle:before,
    .noUi-handle:after {
        display: none;
    }

    .noUi-connect {
        background: rgba(1, 33, 105, 1);
    }

    .noUi-pips-horizontal {
        transform: translate(6px);
    }

    .tab-bar {
        background: #ffffff;
        border-radius: 10px;
        padding-left: 10px;
        padding-right: 10px;
        box-shadow: 0px 2px 5px 4px rgba(0, 0, 0, 0.1);
    }

    .tab-block {
        margin-left: 20px;
        margin-right: -60px;
    }

    .chrom-content-section {
        margin-left: 20px;
    }

    .faded-line {
        border-top: 0.5px solid rgb(133, 139, 146);
        margin-top: 10px;
    }

    .content-container {
        background: #ffffff;
        padding: 20px 40px;
        border-radius: 10px;
        box-shadow: 0px 2px 5px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
</style>
{% endblock %} {% block javascript %} {{ block.super }}
<script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/nouislider.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/exp_viz/vizUtils.js' %}"></script>
<script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
{% endblock %} {% block title %}Experiment{% endblock %} {% block content %}
<div class="flex flex-column justify-center min-w-full">
    <div class="experiment-content-section content-container min-w-fit max-w-fit">
        <table class="min-w-fit max-w-fit">
            <thead class="bg-white border-b">
                <tr>
                    <div class="text-2xl font-bold">
                        <i class="bi bi-funnel-fill" style="color: rgb(11, 11, 107)"></i> {{ experiment.name }}
                    </div>
                </tr>
            </thead>
            <tbody>
                <tr class="bg-gray-100 border-b">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Assay</td>
                    <td class="text-sm text-gray-500 font-light px-6 py-4 whitespace-nowrap" style="font-style: italic">
                        {{ experiment.experiment_type }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Cell Lines</td>
                    <td class="text-sm text-gray-500 font-light px-6 py-4 whitespace-nowrap" style="font-style: italic">
                        {{ experiment.cell_lines|join:", " }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Tissue Type</td>
                    <td class="text-sm text-gray-500 font-light px-6 py-4 whitespace-nowrap" style="font-style: italic">
                        {{ experiment.tissue_types|join:", " }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Assemblies</td>
                    <td class="text-sm text-gray-500 font-light px-6 py-4 whitespace-nowrap" style="font-style: italic">
                        {{ experiment.assemblies|join:", " }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="tab-block">
    <div class="flex flex-column justify-center">
        <ul
            class="mb-5 flex list-none flex-col flex-wrap border-b-0 pl-0 md:flex-row tab-bar"
            role="tablist"
            data-te-nav-ref
        >
            <li role="presentation">
                <a
                    href="#tabs-coverage"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    data-te-toggle="pill"
                    data-te-target="#tabs-coverage"
                    data-te-nav-active
                    role="tab"
                    aria-controls="tabs-coverage"
                    aria-selected="true"
                    >Coverage <i class="bi bi-layers-half"></i
                ></a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-details"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-details-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-details"
                    role="tab"
                    aria-controls="tabs-details"
                    aria-selected="false"
                    >Details <i class="bi bi-file-text"></i>
                </a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-files"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-files-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-files"
                    role="tab"
                    aria-controls="tabs-files"
                    aria-selected="false"
                    >Files <i class="bi bi-folder-symlink-fill"></i
                ></a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-qc-graphs"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-qc-graphs-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-qc-graphs"
                    role="tab"
                    aria-controls="tabs-qc-graphs"
                    aria-selected="false"
                    >QC Graphs <i class="bi bi-file-bar-graph-fill"></i
                ></a>
            </li>
        </ul>
    </div>
    <div
        class="hidden opacity-0 opacity-100 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-coverage"
        role="tabpanel"
        aria-labelledby="tabs-coverage-tab"
        data-te-tab-active
    >
        <div class="flex flex-row">
            <div id="chrom-data-filters" class="basis-1/4">
                <!-- #content section container for facet side bar -->
                <div class="facet-content-section content-container">
                    <div class="text-slate-500">
                        <span id="chrom-data-header" class="text-xl font-bold"></span
                        ><span class="bi bi-layers-half" style="margin-left: 0.5em"></span>
                    </div>
                    <div class="faded-line"></div>
                    <div id="chrom-data-discrete-facets"></div>
                    <div id="chrom-data-continuous-facets"></div>
                    <div id="chrom-data-counts"></div>
                </div>

                <div class="facet-content-section content-container">
                    <form name="regionUploadForm">
                        <div>
                            <label class="font-bold" for="regionFile">Highlight Regions</label>
                            <input id="regionUploadInput" type="file" accept=".bed" name="regionFile" />
                        </div>
                    </form>
                </div>
            </div>
            <div class="basis-2/3">
                <!-- #content section container for ChromCov -->
                <div class="chrom-content-section content-container">
                    <div id="chrom-data-legend"></div>
                    <div id="chrom-data"></div>
                </div>
            </div>
        </div>
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-details"
        role="tabpanel"
        aria-labelledby="tabs-details-tab"
    >
        <div class="experiment-content-section content-container">
            <table class="min-w-full">
                <thead class="bg-white border-b">
                    <tr>
                        <div class="text-2xl font-bold"><i class="bi bi-funnel"></i> {{ experiment.name }}</div>
                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">Description</th>
                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                            {{ experiment.description }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="bg-gray-100 border-b">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Assay</td>
                        <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                            {{ experiment.experiment_type }}
                        </td>
                    </tr>
                    <tr class="bg-white border-b">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Cell Lines</td>
                        <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                            {{ experiment.cell_lines|join:", " }}
                        </td>
                    </tr>
                    <tr class="bg-gray-100 border-b">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Tissue Type</td>
                        <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                            {{ experiment.tissue_types|join:", " }}
                        </td>
                    </tr>
                    <tr class="bg-white border-b">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Assemblies</td>
                        <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                            {{ experiment.assemblies|join:", " }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-files"
        role="tabpanel"
        aria-labelledby="tabs-files-tab"
    >
        <div class="datafile-content-section content-container">
            <div class="container mx-auto">
                <div class="flex flex-col">
                    <div class="w-full">
                        <table class="divide-y divide-gray-400" id="dataFilesTable">
                            <div class="text-xl font-bold" style="color: gray">
                                Data Files <i class="bi bi-folder-symlink-fill"></i>
                            </div>
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-2 text-xs text-white">File Name</th>
                                    <th class="px-6 py-2 text-xs text-white">Description</th>
                                    <th class="px-6 py-2 text-xs text-white">File Type</th>
                                    <th class="px-6 py-2 text-xs text-white">File Size</th>
                                    <th class="px-6 py-2 text-xs text-white">Download</th>
                                </tr>
                            </thead>
                            {% if experiment.data_files.all|length > 0 %} {% for file in experiment.data_files.all %}
                            <tbody class="bg-white divide-y divide-gray-300">
                                <tr class="text-center whitespace-nowrap">
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-500 w-[100px]">
                                            <p class="text-ellipsis overflow-hidden ...">{{ file.filename }}</p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-900 w-[600px]">
                                            <p class="text-ellipsis overflow-hidden ...">{{ file.description }}</p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">File Type</td>
                                    <td class="px-6 py-4">File Size</td>
                                    <td class="px-6 py-4">
                                        <a href="#" class="inline-block text-center">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                            {% endfor %} {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="datafile-content-section content-container">
            <div class="container mx-auto">
                <div class="flex flex-col">
                    <div class="w-full">
                        <table class="divide-y divide-gray-300" id="otherFilesTable">
                            <div class="text-xl font-bold" style="color: gray">
                                Other Files <i class="bi bi-folder-symlink-fill"></i>
                            </div>
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-2 text-xs text-white">File Name</th>
                                    <th class="px-6 py-2 text-xs text-white">Description</th>
                                    <th class="px-6 py-2 text-xs text-white">Location</th>
                                    <th class="px-6 py-2 text-xs text-white">File Type</th>
                                    <th class="px-6 py-2 text-xs text-white">File Size</th>
                                    <th class="px-6 py-2 text-xs text-white">Download</th>
                                </tr>
                            </thead>
                            {% if experiment.other_files.all|length > 0 %} {% for file in experiment.other_files.all %}
                            <tbody class="bg-white divide-y divide-gray-300">
                                <tr class="text-center whitespace-nowrap">
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-500 w-[100px]">
                                            <p class="text-ellipsis overflow-hidden ...">{{ file.filename }}</p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-900 w-[400px]">
                                            <p class="text-ellipsis overflow-hidden ...">{{ file.description }}</p>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-900">
                                            <a href="{{ file.url }}">{{ file.url }}</a>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">File Type</td>
                                    <td class="px-6 py-4">File Size</td>
                                    <td class="px-6 py-4">
                                        <a href="#" class="inline-block text-center">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                            {% endfor %} {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-qc-graphs"
        role="tabpanel"
        aria-labelledby="tabs-qc-graphs-tab"
    >
        <div class="datafile-content-section content-container min-w-max max-w-max">QC plots TK</div>
    </div>
</div>
{% endblock %} {% block inline_javascript %}
<script>
    $(document).ready(function () {
        $("#dataFilesTable").DataTable({
            columns: [null, {orderable: false}, null, {orderable: false}, {orderable: false}],
            info: false,
            paging: false,
            searching: false,
        });
        $("#otherFilesTable").DataTable({
            columns: [null, {orderable: false}, {orderable: false}, null, {orderable: false}, {orderable: false}],
            info: false,
            paging: false,
            searching: false,
        });
    });
</script>
<script type="module">
    import {a, cc, e, g, rc, t} from "{% static 'search/js/dom.js' %}";
    import {State} from "{% static 'search/js/state.js' %}";
    import {getRegions} from "{% static 'search/js/bed.js' %}";
    import {getJson, postJson} from "{% static 'search/js/files.js' %}";
    import {Legend} from "{% static 'search/js/exp_viz/obsLegend.js' %}";
    import {sourceColors, targetColors, GenomeRenderer} from "{% static 'search/js/exp_viz/chromosomeSvg.js' %}";
    import {mergeCoverageData, mergeFacets} from "{% static 'search/js/exp_viz/mergeDataStructures.js' %}";

    let genome;
    let genomeName;
    let coverageData;
    let facets;
    try {
        let manifest = await getJson(
            "{% get_static_prefix %}search/experiments/{{ experiment.accession_id }}/coverage_manifest.json"
        );
        genome = await getJson(
            `{% get_static_prefix %}search/experiments/{{ experiment.accession_id }}/${manifest.genome.file}`
        );
        genomeName = manifest.genome.name;
        coverageData = manifest.chromosomes;
        facets = manifest.facets;
    } catch (error) {
        // If the files can't be loaded we don't want to even try to show the visualization.
    }

    const genomeRenderer = new GenomeRenderer(genome);

    const STATE_ZOOMED = "state-zoomed";
    const STATE_ZOOM_CHROMO_INDEX = "state-zoom-chromo-index";
    const STATE_SCALE = "state-scale";
    const STATE_SCALE_X = "state-scale-x";
    const STATE_SCALE_Y = "state-scale-y";
    const STATE_VIEWBOX = "state-viewbox";
    const STATE_FACETS = "state-facets";
    const STATE_DISCRETE_FACET_VALUES = "state-discrete-facets";
    const STATE_CONTINUOUS_FACET_VALUES = "state-continuous-facets";
    const STATE_COUNT_FILTER_VALUES = "state-count-filter";
    const STATE_COVERAGE_DATA = "state-coverage-data";
    const STATE_ALL_FILTERED = "state-all-filtered";
    const STATE_CONTINUOUS_FILTER_INTERVALS = "state-continuous-filter-intervals";
    const STATE_COUNT_FILTER_INTERVALS = "state-count-filter-intervals";
    const STATE_HIGHLIGHT_REGIONS = "state-highlight-regions";
    const STATE_SELECTED_EXPERIMENTS = "state-selected-experiments";

    let sourceCountInterval = levelCountInterval(coverageData, "source_intervals");
    let targetCountInterval = levelCountInterval(coverageData, "target_intervals");
    let effectSizeInterval = facets.filter((f) => f.name === "Effect Size")[0].range;
    let sigInterval = facets.filter((f) => f.name === "Significance")[0].range;
    let state = new State({
        [STATE_ZOOMED]: false,
        [STATE_ZOOM_CHROMO_INDEX]: undefined,
        [STATE_SCALE]: 1,
        [STATE_SCALE_X]: 1,
        [STATE_SCALE_Y]: 1,
        [STATE_VIEWBOX]: [0, 0, genomeRenderer.renderContext.viewWidth, genomeRenderer.renderContext.viewHeight],
        [STATE_FACETS]: facets,
        [STATE_DISCRETE_FACET_VALUES]: [],
        [STATE_COVERAGE_DATA]: coverageData,
        [STATE_ALL_FILTERED]: coverageData,
        [STATE_CONTINUOUS_FILTER_INTERVALS]: {effect: effectSizeInterval, sig: sigInterval},
        [STATE_CONTINUOUS_FACET_VALUES]: [effectSizeInterval, sigInterval],
        [STATE_COUNT_FILTER_INTERVALS]: {source: sourceCountInterval, target: targetCountInterval},
        [STATE_COUNT_FILTER_VALUES]: [sourceCountInterval, targetCountInterval],
        [STATE_HIGHLIGHT_REGIONS]: {},
        [STATE_SELECTED_EXPERIMENTS]: ["{{ experiment.accession_id }}"],
    });

    genomeRenderer.onBucketClick = (i, chromName, start, end, renderer) => {
        let zoomed = state.g(STATE_ZOOMED);
        if (zoomed) {
            window.open(`/search/results/?query=chr${chromName}:${start}-${end}+${genomeName}`, "_blank");
        } else {
            state.u(STATE_VIEWBOX, [
                renderer.renderContext.xInset +
                    renderer.renderContext.toPx(start) * 30 -
                    renderer.renderContext.viewHeight / 6,
                renderer.renderContext.yInset +
                    (renderer.chromDimensions.chromHeight + renderer.chromDimensions.chromSpacing) * i * 15 -
                    renderer.renderContext.viewHeight / 6,
                renderer.renderContext.viewWidth,
                renderer.renderContext.viewHeight,
            ]);
            state.u(STATE_ZOOM_CHROMO_INDEX, i);
            state.u(STATE_ZOOMED, !zoomed);
        }
    };

    genomeRenderer.onBackgroundClick = (rect, renderer) => {
        let zoomed = state.g(STATE_ZOOMED);
        if (zoomed) {
            state.u(STATE_VIEWBOX, [0, 0, renderer.renderContext.viewWidth, renderer.renderContext.viewHeight]);
            state.u(STATE_ZOOM_CHROMO_INDEX, undefined);
            state.u(STATE_ZOOMED, !zoomed);
        }
    };

    rc(g("chrom-data-header"), t("Experiment Coverage"));

    function render() {
        const viewBox = state.g(STATE_VIEWBOX);
        const scale = state.g(STATE_SCALE);
        const scaleX = state.g(STATE_SCALE_X);
        const scaleY = state.g(STATE_SCALE_Y);
        const highlightRegions = state.g(STATE_HIGHLIGHT_REGIONS);
        let currentLevel = state.g(STATE_ALL_FILTERED);
        let focusIndex = state.g(STATE_ZOOM_CHROMO_INDEX);
        let countIntervals = state.g(STATE_COUNT_FILTER_INTERVALS);
        let sourceCountInterval = countIntervals.source;
        let targetCountInterval = countIntervals.target;

        rc(
            g("chrom-data"),
            genomeRenderer.render(
                currentLevel,
                focusIndex,
                sourceCountInterval,
                targetCountInterval,
                viewBox,
                scale,
                scaleX,
                scaleY,
                highlightRegions
            )
        );
        rc(
            g("chrom-data-legend"),
            Legend(d3.scaleSequential(sourceCountInterval, sourceColors), {
                title: "Source Count",
            })
        );
        a(
            g("chrom-data-legend"),
            Legend(d3.scaleSequential(targetCountInterval, targetColors), {
                title: "Target Count",
            })
        );
    }

    render();

    function levelCountInterval(chroms, interval, chromoIndex) {
        if (chromoIndex) {
            chroms = [chroms[chromoIndex]];
        }
        let max = Number.NEGATIVE_INFINITY;
        let min = Number.POSITIVE_INFINITY;
        for (const chrom of chroms) {
            const count = chrom[interval].map((d) => d.count);
            max = Math.max(max, Math.max(...count));
            min = Math.min(min, Math.min(...count));
        }

        if (max == Number.NEGATIVE_INFINITY || min == Number.POSITIVE_INFINITY) {
            return [0, 0];
        }

        return [min, max];
    }

    let discreteFacets = g("chrom-data-discrete-facets");
    function discreteFilterControls(facets) {
        return facets
            .filter((f) => f.facet_type == "FacetType.DISCRETE")
            .map((facet) => {
                return e("fieldset", {name: "facetfield", class: "my-4"}, [
                    e("legend", {class: "font-bold"}, facet.name),
                    e(
                        "div",
                        {class: "flex flex-row flex-wrap gap-1"},
                        Object.entries(facet.values).map((entry) => {
                            return e("div", {class: "ml-1"}, [
                                e("input", {type: "checkbox", id: entry[0], name: facet.name}, []),
                                e("label", {for: entry[0]}, entry[1]),
                            ]);
                        })
                    ),
                ]);
            });
    }

    let continuousFacets = g("chrom-data-continuous-facets");
    function continuousFilterControls(facets) {
        const contFacets = facets.filter((f) => f.facet_type == "FacetType.CONTINUOUS");
        let sliderNodes = [e("div", {name: "facetslider"}, []), e("div", {name: "facetslider"}, [])];
        let filterNodes = [];
        let intervals = state.g(STATE_CONTINUOUS_FILTER_INTERVALS);

        for (let i = 0; i < contFacets.length; i++) {
            let facet = contFacets[i];
            let sliderNode = sliderNodes[i];

            let range;

            if (facet.name === "Effect Size") {
                range = intervals.effect;
            } else if (facet.name === "Significance") {
                range = intervals.sig;
            } else {
                continue;
            }

            noUiSlider.create(sliderNode, {
                start: [range[0], range[1]],
                format: {
                    to: (n) => n.toPrecision(3),
                    from: (s) => Number.parseFloat(s),
                },
                connect: true,
                range: {
                    min: range[0],
                    max: range[1],
                },
                pips: {
                    mode: "range",
                    density: 5,
                    format: {
                        to: (n) => n.toPrecision(3),
                        from: (s) => Number.parseFloat(s),
                    },
                },
            });

            sliderNode.noUiSlider.on("start", function (values, handle) {
                sliderNode.noUiSlider.updateOptions({tooltips: [true, true]});
            });

            sliderNode.noUiSlider.on("end", function (values, handle) {
                sliderNode.noUiSlider.updateOptions({tooltips: [false, false]});
            });

            filterNodes.push(e("div", {class: "h-24 w-72"}, [e("div", facet.name), sliderNode]));
        }

        sliderNodes.forEach((sliderNode) => {
            sliderNode.noUiSlider.on("slide", function (values, handle) {
                state.u(
                    STATE_CONTINUOUS_FACET_VALUES,
                    sliderNodes.map((n) => n.noUiSlider.get(true))
                );
            });
        });

        return filterNodes;
    }

    function countFilterControls() {
        let sliderNodes = [e("div", {name: "facetslider"}, []), e("div", {name: "facetslider"}, [])];
        let filterNodes = [];
        let intervals = state.g(STATE_COUNT_FILTER_INTERVALS);

        let range = intervals.source;

        for (let i = 0; i < 2; i++) {
            let sliderNode = sliderNodes[i];

            let range;
            let name;

            if (i == 0) {
                range = intervals.source;
                name = "Source Count";
            } else if (i == 1) {
                range = intervals.target;
                name = "Target count";
            } else {
                continue;
            }

            noUiSlider.create(sliderNode, {
                start: [range[0], range[1]],
                step: 1,
                connect: true,
                range: {
                    min: range[0],
                    max: range[1],
                },
                pips: {
                    mode: "range",
                    density: 5,
                },
            });

            sliderNode.noUiSlider.on("start", function (values, handle) {
                sliderNode.noUiSlider.updateOptions({tooltips: [true, true]});
            });

            sliderNode.noUiSlider.on("end", function (values, handle) {
                sliderNode.noUiSlider.updateOptions({tooltips: [false, false]});
            });

            filterNodes.push(e("div", {class: "h-24 w-72"}, [e("div", name), sliderNode]));
        }

        sliderNodes.forEach((sliderNode) => {
            sliderNode.noUiSlider.on("slide", function (values, handle) {
                state.u(
                    STATE_COUNT_FILTER_VALUES,
                    sliderNodes.map((n) => n.noUiSlider.get(true))
                );
            });
        });

        return filterNodes;
    }

    countFilterControls().forEach((element) => {
        a(g("chrom-data-counts"), element);
    });

    function getFilterBody(filter_values) {
        let filters = {
            filters: filter_values,
            chromosomes: genome.map((c) => c.chrom),
        };
        if (state.g(STATE_ZOOMED)) {
            let zoomChromoIndex = state.g(STATE_ZOOM_CHROMO_INDEX);
            filters.zoom = coverageData[zoomChromoIndex].chrom;
        }

        return filters;
    }

    function mergeFilteredData(current_data, response_data) {
        let resp_obj = response_data.reduce((obj, chrom) => {
            obj[chrom.chrom] = chrom;
            return obj;
        }, {});

        return current_data.map((chrom) => {
            return chrom.chrom in resp_obj ? resp_obj[chrom.chrom] : chrom;
        });
    }

    function experimentsQuery() {
        let selectedExperiments = state.g(STATE_SELECTED_EXPERIMENTS);
        return selectedExperiments.map((e) => `exp=${e}`).join("&");
    }

    state.ac(STATE_ZOOMED, (s, key) => {
        const zoomed = s[key];
        state.u(STATE_SCALE, zoomed ? 15 : 1);
        state.u(STATE_SCALE_X, zoomed ? 30 : 1);
        state.u(STATE_SCALE_Y, zoomed ? 15 : 1);

        let body = getFilterBody([state.g(STATE_DISCRETE_FACET_VALUES), state.g(STATE_CONTINUOUS_FACET_VALUES)]);

        postJson(`/search/experiment_coverage?${experimentsQuery()}`, JSON.stringify(body)).then((response_json) => {
            state.u(STATE_COVERAGE_DATA, mergeFilteredData(state.g(STATE_COVERAGE_DATA), response_json.chromosomes));
        });
    });

    state.ac(STATE_ALL_FILTERED, (s, key) => {
        render();
    });

    state.ac(
        STATE_DISCRETE_FACET_VALUES,
        _.debounce((s, key) => {
            // Send facet data to server to get filtered data and updated continuous facets
            let body = getFilterBody([state.g(STATE_DISCRETE_FACET_VALUES)]);

            postJson(`/search/experiment_coverage?${experimentsQuery()}`, JSON.stringify(body)).then(
                (response_json) => {
                    state.u(
                        STATE_COVERAGE_DATA,
                        mergeFilteredData(state.g(STATE_COVERAGE_DATA), response_json.chromosomes)
                    );
                    state.u(STATE_CONTINUOUS_FILTER_INTERVALS, response_json.continuous_intervals);
                    state.u(
                        STATE_CONTINUOUS_FACET_VALUES,
                        [response_json.continuous_intervals.effect, response_json.continuous_intervals.sig],
                        false
                    );
                }
            );
        }, 300)
    );

    state.ac(
        STATE_CONTINUOUS_FACET_VALUES,
        _.debounce((s, key) => {
            // Send facet data to server to get filtered data and updated continuous facets
            let body = getFilterBody([state.g(STATE_DISCRETE_FACET_VALUES), state.g(STATE_CONTINUOUS_FACET_VALUES)]);

            postJson(`/search/experiment_coverage?${experimentsQuery()}`, JSON.stringify(body)).then(
                (response_json) => {
                    state.u(
                        STATE_COVERAGE_DATA,
                        mergeFilteredData(state.g(STATE_COVERAGE_DATA), response_json.chromosomes)
                    );
                }
            );
        }, 300)
    );

    state.ac(STATE_CONTINUOUS_FILTER_INTERVALS, (s, key) => {
        cc(g("chrom-data-continuous-facets"));
        continuousFilterControls(state.g(STATE_FACETS)).forEach((element) =>
            a(g("chrom-data-continuous-facets"), element)
        );
    });

    state.ac(STATE_COUNT_FILTER_INTERVALS, (s, key) => {
        cc(g("chrom-data-counts"));
        countFilterControls().forEach((element) => a(g("chrom-data-counts"), element));
    });

    let countFacetWorker;
    if (window.Worker) {
        countFacetWorker = new Worker("{% static 'search/js/exp_viz/countFacetFilterWorker.js' %}");
        countFacetWorker.onmessage = (cf) => {
            state.u(STATE_ALL_FILTERED, cf.data);
        };
    }

    state.ac(
        STATE_COUNT_FILTER_VALUES,
        _.debounce((s, key) => {
            if (countFacetWorker) {
                countFacetWorker.postMessage({
                    data: state.g(STATE_COVERAGE_DATA),
                    countFilters: state.g(STATE_COUNT_FILTER_VALUES),
                });
            }
        }, 60)
    );

    state.ac(STATE_HIGHLIGHT_REGIONS, (s, key) => {
        render();
    });

    function setFacetControls(facets) {
        cc(discreteFacets);
        discreteFilterControls(facets).forEach((element) => {
            a(discreteFacets, element);
        });
        let facetCheckboxes = discreteFacets.querySelectorAll("input[type=checkbox]");
        facetCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", (_) => {
                let checkedFacets = Array.from(facetCheckboxes) // Convert checkboxes to an array to use filter and map.
                    .filter((i) => i.checked) // Use Array.filter to remove unchecked checkboxes.
                    .map((i) => Number(i.id));
                state.u(STATE_DISCRETE_FACET_VALUES, checkedFacets);
            });
        });

        let effectSizeInterval = facets.filter((f) => f.name === "Effect Size")[0].range;
        let sigInterval = facets.filter((f) => f.name === "Significance")[0].range;
        state.u(STATE_CONTINUOUS_FILTER_INTERVALS, {effect: effectSizeInterval, sig: sigInterval});
    }

    function setCountControls(coverageData) {
        let sourceCountInterval = levelCountInterval(coverageData, "source_intervals");
        let targetCountInterval = levelCountInterval(coverageData, "target_intervals");
        state.u(STATE_COUNT_FILTER_INTERVALS, {source: sourceCountInterval, target: targetCountInterval});
        state.u(STATE_COUNT_FILTER_VALUES, [sourceCountInterval, targetCountInterval]);
    }

    state.ac(STATE_FACETS, (s, key) => {
        setFacetControls(s[key]);
    });

    state.ac(STATE_COVERAGE_DATA, (s, key) => {
        setCountControls(s[key]);
    });

    setFacetControls(state.g(STATE_FACETS));

    let regionReader = new FileReader();
    regionReader.addEventListener(
        "load",
        () => {
            state.u(STATE_HIGHLIGHT_REGIONS, getRegions(regionReader.result));
        },
        false
    );

    function getHighlightRegions() {
        if (this.files.length != 1) {
            return;
        }
        regionReader.readAsText(this.files[0]);
    }

    g("regionUploadInput").addEventListener("change", getHighlightRegions, false);
</script>
<script src="{% static 'js/tw-elements/index.min.js' %}"></script>
{% endblock %}
