{% extends "base.html" %}

{% load static i18n %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<link href="{% static 'css/nouislider.min.css' %}" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite-api@4"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-tooltip"></script>
<!-- This CSS modifies the range slider look -->
<style>
      /***** MODAL DIALOG ****/
    #exp-modal {
        /* Underlay covers entire screen. */
        position: fixed;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;

        /* Flexbox centers the .modal-content vertically and horizontally */
        display: flex;
        flex-direction: column;
        align-items: center;

        /* Animate when opening */
        animation-name: fadeIn;
        animation-duration: 150ms;
        animation-timing-function: ease;
    }

    #exp-modal > .exp-modal-underlay {
        /* underlay takes up the entire viewport. This is only
        required if you want to click to dismiss the popup */
        position: absolute;
        z-index: -1;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
    }

    #exp-modal > .exp-modal-content {
        /* Position visible dialog near the top of the window */
        margin-top: 10vh;

        /* Sizing for visible dialog */
        width: 95%;
        max-height: 85%;

        /* Display properties for visible dialog*/
        border: solid 1px #999;
        border-radius: 8px;
        box-shadow: 0px 0px 20px 0px rgba(0,0,0,0.3);
        background-color: white;

        /* Animate when opening */
        animation-name: zoomIn;
        animation-duration: 150ms;
        animation-timing-function: ease;
    }

    .exp-modal-button {
        background-color: white !important;
        color: rgb(71 85 105);
        font-weight: bold;
    }

    .exp-modal-button:hover {
        background-color: rgb(229 231 235) !important;
        border-color: white;
    }

    #exp-modal .scroll-bounds {
        margin-bottom: 20px;
    }

    #exp-modal .scroll-area {
        overflow-y: scroll;
        height: calc(100% - 30px);
        margin-top: 10px;
        padding-top: 10px;
        padding-left: 10px;
        padding-right: 10px;
    }

    #exp-modal.closing {
        /* Animate when closing */
        animation-name: fadeOut;
        animation-duration: 150ms;
        animation-timing-function: ease;
    }

    #exp-modal.closing > .exp-modal-content {
        /* Animate when closing */
        animation-name: zoomOut;
        animation-duration: 150ms;
        animation-timing-function: ease;
    }

    .noUi-horizontal {
        height: 10px;
    }

    .noUi-horizontal .noUi-handle {
        width: 20px;
        height: 20px;
    }

    .noUi-handle {
        border-radius: 10px;
    }

    .noUi-handle:before,
    .noUi-handle:after {
        display: none;
    }

    .noUi-connect {
        background: rgba(1, 33, 105, 1);
    }

    .noUi-pips-horizontal {
        transform: translate(6px);
    }

    select {
        font-size: 0.9rem;
        padding: 5px 5px;
    }

    .analysis-button {
        margin-left: 5px;
        background-color: rgb(244, 245, 247) !important;
    }

    .analysis-button:hover {
         background-color: rgb(229 231 235) !important;
    }

    #chrom-data-legend {
        position:relative;
    }
</style>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/nouislider.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/exp_viz/vizUtils.js' %}"></script>
<script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
{% endblock %}

{% block title %}Experiment{% endblock %}

{% block content %}
<div class="flex flex-column justify-center min-w-full">
    <div class="content-container min-w-fit max-w-fit">
        {% if experiment.archived %}
        <div class="bg-red-300 text-center text-xl font-bold py-2 my-1">
            This experiment has been archived.
        </div>
        {% endif %}
        <div class="bg-white border-b">
            <div class="text-2xl font-bold flex items-center justify-center" style="color: rgb(71 85 105);">
                <span><i class="fa-solid fa-flask-vial mr-1"></i>{{ experiment.name }}
                {% if analyses|length > 1 %}
                    <select class="analysis-button border-2 p-2 text-sm mb-0.5 ml-1" id="analysisSelector">
                        {% for analysis in analyses %}
                            <option value="{% url 'search:experiment' experiment.accession_id %}?analysis={{ analysis.1 }}" {{ analysis.0 }}>v{{ forloop.counter }}</option>
                        {% endfor %}
                    </select>
                {% elif analyses|length == 1  %}
                    v1
                {% endif %}
                </span>
            </div>
        </div>
        <div class="bg-gray-100 border-b flex flex-wrap justify-between">
            <div class="flex items-center px-6 py-4">
                <div class="text-sm font-medium text-gray-900">Assay</div>
                <div class="text-sm text-gray-500 font-light italic ml-2">
                    {{ experiment.experiment_type }}
                </div>
            </div>
            <div class="flex items-center px-6 py-4">
                <div class="text-sm font-medium text-gray-900">Cell Lines</div>
                <div class="text-sm text-gray-500 font-light italic ml-2">
                    {{ experiment.cell_lines|join:", " }}
                </div>
            </div>
            <div class="flex items-center px-6 py-4">
                <div class="text-sm font-medium text-gray-900">Tissue Type</div>
                <div class="text-sm text-gray-500 font-light italic ml-2">
                    {{ experiment.tissue_types|join:", " }}
                </div>
            </div>
            <div class="flex items-center px-6 py-4">
                <div class="text-sm font-medium text-gray-900">Assembly</div>
                <div class="text-sm text-gray-500 font-light italic ml-2">
                    {{ experiment.genome_assembly }}
                </div>
            </div>

        </div>
        <div class="flex justify-center">
            <button class="exp-modal-button mt-3 border-2 p-2" hx-get="{% url 'search:experiments' %}" hx-trigger="click" hx-swap="innerHTML" hx-target="#modal-container">
                <div class="flex flex-column items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-icon mx-1.5"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                    <path d="M40 48C26.7 48 16 58.7 16 72v48c0 13.3 10.7 24 24 24H88c13.3 0 24-10.7 24-24V72c0-13.3-10.7-24-24-24H40zM192 64c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zM16 232v48c0 13.3 10.7 24 24 24H88c13.3 0 24-10.7 24-24V232c0-13.3-10.7-24-24-24H40c-13.3 0-24 10.7-24 24zM40 368c-13.3 0-24 10.7-24 24v48c0 13.3 10.7 24 24 24H88c13.3 0 24-10.7 24-24V392c0-13.3-10.7-24-24-24H40z"/>/>
                    </svg>Change Experiment
                </div>
            </button>
            <div id="modal-container">
            </div>
        </div>
    </div>
</div>

<div class="min-w-full max-w-full">
    <div class="flex flex-column justify-center">
        <ul
            class="mb-5 flex list-none flex-col flex-wrap border-b-0 pl-0 md:flex-row tab-bar"
            role="tablist"
            data-te-nav-ref
        >
            <li role="presentation">
                <a
                    href="#tabs-overview"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-overview-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-overview"
                    data-te-nav-active
                    role="tab"
                    aria-controls="tabs-overview"
                    aria-selected="true"
                    >Overview <i class="bi bi-layers-half"></i
                ></a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-details"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-details-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-details"
                    role="tab"
                    aria-controls="tabs-details"
                    aria-selected="false"
                    >Details <i class="bi bi-file-text"></i>
                </a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-files"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-files-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-files"
                    role="tab"
                    aria-controls="tabs-files"
                    aria-selected="false"
                    >Files <i class="bi bi-folder-symlink-fill"></i
                ></a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-qc-graphs"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-qc-graphs-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-qc-graphs"
                    role="tab"
                    aria-controls="tabs-qc-graphs"
                    aria-selected="false"
                    >QC Graphs <i class="bi bi-file-bar-graph-fill"></i
                ></a>
            </li>
            <li role="presentation">
                <a
                    href="#tabs-analysis"
                    class="my-2 block border-x-0 border-t-0 border-b-2 border-transparent px-7 pt-4 pb-3.5 text-xs font-medium uppercase leading-tight text-neutral-500 hover:isolate hover:border-transparent hover:bg-neutral-100 focus:isolate focus:border-transparent data-[te-nav-active]:border-primary data-[te-nav-active]:text-primary dark:text-neutral-400 dark:hover:bg-transparent dark:data-[te-nav-active]:border-primary-400 dark:data-[te-nav-active]:text-primary-400 no-underline"
                    id="tabs-analysis-tab"
                    data-te-toggle="pill"
                    data-te-target="#tabs-analysis"
                    role="tab"
                    aria-controls="tabs-analysis"
                    aria-selected="false"
                    >Analysis <i class="bi bi-pie-chart-fill"></i
                ></a>
            </li>
        </ul>
    </div>
    <div
        class="hidden opacity-0 opacity-100 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-overview"
        role="tabpanel"
        aria-labelledby="tabs-overview-tab"
        data-te-tab-active
    >
        <div class="flex flex-col md:flex-row max-w-full gap-x-10">
            <div id="chrom-data-filters" class="basis-1/4">
                <!-- content section container for facet side bar -->
                <div class="facet-content-section content-container">
                    <div class="text-slate-500 flex justify-center">
                        <span id="chrom-data-header" class="text-xl font-bold"></span
                        ><span class="bi bi-layers-half ml-2"></span>
                    </div>
                    <div class="title-separator"></div>
                    <div id="chrom-data-categorical-facets"></div>
                    <div id="chrom-data-numeric-facets"></div>
                    <div id="chrom-data-counts"></div>
                </div>

                <div class="facet-content-section content-container hidden md:block">
                    <form name="regionUploadForm">
                        <div>
                            <label class="font-bold flex justify-center" for="regionFile">Highlight Regions</label>
                            <input class="hidden" id="regionUploadInput" type="file" accept=".bed" name="regionFile"/>
                            <label for="regionUploadInput" class="flex justify-center global-button mt-3 border-2 p-2 text-sm">Upload File</label>
                        </div>
                    </form>
                    <div id="regionUploadInputReset"></div>
                </div>


                <div class="facet-content-section content-container hidden md:block">
                  <div class="logged-in-only-container">
                    {% if not logged_in %}
                    <div class="grid grid-cols-1 place-content-center logged-in-only-overlay">
                        <h3 class="flex items-center justify-center">Please Login to Download Data</h3>
                    </div>
                    {% endif %}
                    <form name="dataDownloadForm">
                        <div>
                            <label class="font-bold flex justify-center" for="dataDlAll">Download All Selected Data*</label>
                            <input class="hidden" id="dataDownloadAll" type="button" name="dataDlAll" />
                            <label for="dataDownloadAll" class="flex justify-center global-button mt-3 border-2 p-2 text-sm">Request Data</label>
                        </div>
                        <div class="mt-5">
                            <label class="font-bold flex justify-center" for="dataDlFile">Download Some Selected Data*</label>
                            <input class="hidden" id="dataDownloadInput" type="file" accept=".bed" name="dataDlFile" />
                            <label for="dataDownloadInput" class="flex justify-center global-button mt-3 border-2 p-2 text-sm">Upload file</label>
                        </div>
                    </form>
                    <div id="dataDownloadLink" class="mt-5 mb-5"></div>
                    <div class="flex justify-center">
                    * Data downloads take facet filtering, except for "Number of {{ experiment.get_source_type_display }}s" and "Number of Genes Assayed", into account.
                    </div>
                  </div>
                </div>
            </div>

            <div class="content-container basis-3/4">
                <!-- content section container for ChromCov -->
                <div class="flex flex-row flex-wrap gap-x-4 items-center">
                    <div id="chrom-data-legend"></div>
                    <div class="flex flex-col">
                        <div id="reo-count"></div>
                        <div id="source-count"></div>
                        <div id="target-count"></div>
                    </div>
                    <div>
                        <label for="covSelect">View:</label>
                        <select class="global-button border-2 p-2 h-10 text-sm" name="views" id="covSelect">
                            <option value="sig">Largest Significance</option>
                            <option value="effect">Greatest Effect Size</option>
                            <option value="count">{{ experiment.get_source_type_display }}/Gene Count</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <div id="chrom-data" class="min-w-[768px] md:min-w-0"></div>
                </div>
            </div>
        </div>
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-details"
        role="tabpanel"
        aria-labelledby="tabs-details-tab"
    >
        <div class="content-container mx-auto min-w-full grid grid-cols-1 {% if experiment.attribution %}lg:grid-cols-2 {% endif %}gap-4">
          <div>
              <div class="bg-white border-b">
                  <div class="text-xl text-slate-500 font-bold mb-4 text-left">Description</div>
                  <div class="text-sm font-medium text-gray-900 mb-4 text-left">
                      {{ experiment.description }}
                  </div>
              </div>
              <div class="{% cycle 'bg-gray-100' 'bg-white' as rowcolors %} border-b flex items-center">
                  <div class="px-6 py-4whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Assay</div>
                  <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                      {{ experiment.experiment_type }}
                  </div>
              </div>
              <div class="{% cycle rowcolors %} border-b flex items-center">
                  <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Cell Lines</div>
                  <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                      {{ experiment.cell_lines|join:", " }}
                  </div>
              </div>
              <div class="{% cycle rowcolors %} border-b flex items-center">
                  <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Tissue Type</div>
                  <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                      {{ experiment.tissue_types|join:", " }}
                  </div>
              </div>
              <div class="{% cycle rowcolors %} border-b flex items-center">
                  <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Assembly</div>
                  <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                      {{ experiment.genome_assembly }}
                  </div>
              </div>
          </div>
          {% if experiment.attribution %}
          <div>
            <div class="bg-white border-b">
                <div class="text-xl text-slate-500 font-bold mb-4 text-left">Attribution</div>
            </div>
            <div class="{% cycle 'bg-gray-100' 'bg-white' as rowcolors %} border-b flex items-center">
                <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">PI</div>
                <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                    {{ experiment.attribution.pi }}
                </div>
            </div>
            <div class="{% cycle rowcolors %} border-b flex items-center">
                <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Institution</div>
                <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                    {{ experiment.attribution.institution }}
                </div>
            </div>
            {% if experiment.attribution.experimentalist is not None %}
            <div class="{% cycle rowcolors %} border-b flex items-center">
                <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Experimentalist</div>
                <div class="text-sm text-gray-500 font-light py-4 whitespace-nowrap italic w-3/4">
                    {{ experiment.attribution.experimentalist }}
                </div>
            </div>
            {% endif %}
            {% if experiment.attribution.datasource_url is not None %}
            <div class="{% cycle rowcolors %} border-b flex items-center">
                <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Data Source</div>
                <div class="font-light py-4 whitespace-nowrap italic w-3/4 overflow-x-auto">
                    <a class="link" href="{{ experiment.attribution.datasource_url }}">{{ experiment.attribution.datasource_url }}</a>
                </div>
            </div>
            {% endif %}
            {% if experiment.attribution.lab_url is not None %}
            <div class="{% cycle rowcolors %} border-b flex items-center">
                <div class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 min-w-fit w-1/4">Lab Website</div>
                <div class="font-light py-4 whitespace-nowrap italic w-3/4 overflow-x-auto">
                    <a class="link" href="{{ experiment.attribution.lab_url }}">{{ experiment.attribution.lab_url }}</a>
                </div>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% if related_experiments or experiment.collections.exists %}
        <div class="content-container min-w-full grid grid-cols-1 {% if related_experiments and experiment.collections.exists %}lg:grid-cols-2 {% endif %}gap-4">
          {% if related_experiments %}
          <div>
              <div class="bg-white border-b">
                  <div class="text-xl text-slate-500 font-bold mb-4 text-left">Related Experiments</div>
              </div>
              {% for related in related_experiments %}
              <div class="{% cycle 'bg-gray-100' 'bg-white' %} border-b flex items-center">
                  <div class="text-sm px-6 py-4 font-medium w-1/4"><a class="link" href="{% url 'search:experiment' related.other_experiment_id %}">{{ related.name }}</a></div>
                  <div class="text-sm px-6 py-4 text-gray-500 font-light italic w-3/4">
                      {{ related.description|linebreaksbr }}
                  </div>
              </div>
              {% endfor %}
          </div>
          {% endif %}
          {% if experiment.collections.exists %}
          <div>
              <div class="bg-white border-b">
                  <div class="text-xl text-slate-500 font-bold mb-4 text-left">Collections</div>
              </div>
              {% for collection in experiment.collections.all %}
              <div class="{% cycle 'bg-gray-100' 'bg-white' %} border-b flex items-center">
                  <div class="text-sm px-6 py-4 font-medium w-1/4"><a class="link" href="{% url 'search:experiment_collection' collection.accession_id %}">{{ collection.name }}</a></div>
                  <div class="text-sm px-6 py-4 text-gray-500 font-light italic w-3/4">
                      {{ collection.description|default_if_none:"No Description" }}
                  </div>
              </div>
              {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endif %}
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-files"
        role="tabpanel"
        aria-labelledby="tabs-files-tab"
    >
        <div class="content-container mx-auto">
            <div class="text-xl font-bold" style="color: rgb(100 116 139);">
                Data Files <i class="bi bi-folder-symlink-fill"></i>
            </div>
            <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-400" id="dataFilesTable">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-2 text-xs text-white">File Name</th>
                        <th class="px-6 py-2 text-xs text-white">Description</th>
                        <th class="px-6 py-2 text-xs text-white">File Type</th>
                        <th class="px-6 py-2 text-xs text-white">File Size</th>
                        <th class="px-6 py-2 text-xs text-white">Download</th>
                    </tr>
                </thead>
                {% if experiment.data_files.exists %} {% for file in experiment.data_files.all %}
                <tbody class="bg-white divide-y divide-gray-300">
                    <tr class="text-center whitespace-nowrap">
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500 w-[100px]">
                                <p class="text-ellipsis overflow-hidden ...">{{ file.filename }}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 w-[600px]">
                                <p class="text-ellipsis overflow-hidden ...">{{ file.description }}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">File Type</td>
                        <td class="px-6 py-4">File Size</td>
                        <td class="px-6 py-4">
                            <a href="#" class="inline-block text-center">
                                <i class="bi bi-download"></i>
                            </a>
                        </td>
                    </tr>
                </tbody>
                {% endfor %} {% endif %}
            </table>
            </div>
        </div>

        <div class="content-container mx-auto overflow-x-auto ">
            <div class="text-xl font-bold" style="color: rgb(100 116 139);">
                Other Files <i class="bi bi-folder-symlink-fill"></i>
            </div>
            <div class="overflow-x-auto">
            <table class="divide-y divide-gray-300" id="otherFilesTable">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-2 text-xs text-white">File Name</th>
                        <th class="px-6 py-2 text-xs text-white">Description</th>
                        <th class="px-6 py-2 text-xs text-white">Location</th>
                        <th class="px-6 py-2 text-xs text-white">File Type</th>
                        <th class="px-6 py-2 text-xs text-white">File Size</th>
                        <th class="px-6 py-2 text-xs text-white">Download</th>
                    </tr>
                </thead>
                {% if experiment.files.exists %} {% for file in experiment.files.all %}
                <tbody class="bg-white divide-y divide-gray-300">
                    <tr class="text-center whitespace-nowrap">
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500 w-[100px]">
                                <p class="text-ellipsis overflow-hidden ...">{{ file.filename }}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 w-[400px]">
                                <p class="text-ellipsis overflow-hidden ...">{{ file.description }}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">
                                <a href="{{ file.url }}">{{ file.url }}</a>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">File Type</td>
                        <td class="px-6 py-4">File Size</td>
                        <td class="px-6 py-4">
                            <a href="#" class="inline-block text-center">
                                <i class="bi bi-download"></i>
                            </a>
                        </td>
                    </tr>
                </tbody>
                {% endfor %} {% endif %}
            </table>
            </div>
        </div>
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-qc-graphs"
        role="tabpanel"
        aria-labelledby="tabs-qc-graphs-tab"
    >
        <div
            class="content-container mx-auto text-xl font-bold max-w-fit"
            style="color: rgb(100 116 139);"
        >
            QC Graphs <i class="bi bi-file-bar-graph-fill"></i>
            <div class="title-separator my-3.5"></div>
            <div class="flex flex-nowrap my-3.5 max-w-fit overflow-x-auto">
                <div id="ncells_histogram" class="mr-4"></div>
                <div id="ngrna_histogram"></div>
            </div>
        </div>
    </div>
    <div
        class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[te-tab-active]:block"
        id="tabs-analysis"
        role="tabpanel"
        aria-labelledby="tabs-analysis"
    >
        <div
            class="content-container mx-auto text-xl font-bold max-w-fit"
            style="color: rgb(100 116 139);"
        >
            Analysis <i class="bi bi-pie-chart-fill"></i>
            <div class="title-separator my-3.5"></div>
            <div class="flex flex-nowrap my-3.5 max-w-fit overflow-x-auto">
                <div id="volcano" class="mr-4"></div>
                <div id="uniform_qqplot" class="mr-4"></div>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block inline_javascript %}
<script>

    // setup API options
    const vegaVolcanoOptions = {
        config: {
            // Vega-Lite default configuration
        },
        init: (view) => {
            // initialize tooltip handler
            view.tooltip(new vegaTooltip.Handler().call);
        },
    };

    // register vega and vega-lite with the API
    vl.register(vega, vegaLite, vegaVolcanoOptions);

    // now you can use the API!
    plot = (values, subtitle) => {
        return vl
            .markCircle()
            .data(values)
            .width(450)
            .height(400)
            .encode(
                vl.y().fieldQ("0").title("-log10(p-value)"),
                vl.x().fieldQ(1).title("Effect Size"), //.scale({"domain":[0, 2], "clamp": true}),
                vl
                    .color()
                    .fieldN(2)
                    .title("Gene Type")
                    .legend({labelExpr: "{0: 'Targeting', 1: 'Non-Targeting'}[datum.label]"}),
                vl.tooltip(vl.fieldN(3))
            )
            .title({text: "Volcano Plot", subtitle: subtitle, anchor: "start"})
            .render()

            .then((viewElement) => {
                // render returns a promise to a DOM element containing the chart
                // viewElement.value contains the Vega View object instance
                document.getElementById("volcano").appendChild(viewElement);
            });
    };

    const fetchVPUrl = `{% get_static_prefix %}search/experiments/{{ experiment.accession_id }}/{{ analysis_selected }}/vpdata.pd`;
    fetch(fetchVPUrl)
        .then((response) => {
            if (!response.ok && response.status == 404) {
                return; // This is often okay and expected, not every analysis has this data
            }

            if(!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            return new Promise((resolve, reject) => resolve(response.arrayBuffer()))
                .then((buffer) => {
                    // See scripts/data_generation/qc_plots/voclano_plot.py in the source for an explanation of the data
                    // format.
                    let length = buffer.byteLength;
                    let decoder = new TextDecoder();
                    let data = new DataView(buffer);
                    let offset = 0;
                    let values = [];
                    while (offset < length) {
                        let pVal = data.getFloat32(offset);
                        let avgFC = data.getFloat32(offset + 4);
                        let type = data.getUint8(offset + 8);
                        let symLen = data.getUint8(offset + 9);
                        offset += 10;
                        let symArray = new Uint8Array(buffer, offset, symLen);
                        let sym = decoder.decode(symArray);
                        values.push([pVal, avgFC, type, sym]);
                        offset += symLen;
                    }
                    return values;
                })
                .then((values) => {
                    return plot(values, "Significant Observations with Effect Size > 1");
                })
                .catch((err) => console.log(err));
        })
        .catch((err) => console.log(err));


    //Function to process both Histgrams("Number of Cells per gRNA" and "Number od gRNA per cell" )
    function processHistogramData(buffer) {
        // See scripts/data_generation/qc_plots/histogram.py in the source for an explanation of the data
        // format.
        let data = new DataView(buffer);
        let offset = 0;
        let values = [];
        let binSize = data.getUint32(offset);
        let mean = data.getFloat32(offset + 4);
        let median = data.getFloat32(offset + 8);
        let binCount = data.getUint32(offset + 12);
        offset += 16;
        for (let i = 0; i < binCount; i++, offset += 4) {
            let binValue = data.getUint32(offset);
            values.push({
                bin_start: i * binSize,
                bin_end: (i + 1) * binSize,
                count: binValue,
            });
        }

        return {binSize, mean, median, values};
    }

    function createHistogramChart(data, color, chart_title, x_axis_title, elementId) {
        vl.data(data)
            .title(chart_title)
            .width(450)
            .height(300)
            .layer(
                vl
                    .markBar({tooltip: true, color: color})
                    .encode(
                        vl.x().fieldQ("bin_start").bin({step: data.binSize, binned: true}).title(x_axis_title),
                        vl.x2().fieldQ("bin_end"),
                        vl.y().fieldQ("count").title("Counts")
                    ),
                vl
                    .markRule({size: 3, color: "red", tooltip: {content: "encoding"}})
                    .encode(vl.x().datum(data.median), vl.tooltip().value(`Median: ${data.median}`)),
                vl
                    .markRule({size: 3, color: "yellow", tooltip: {content: "encoding"}})
                    .encode(vl.x().datum(data.mean), vl.tooltip().value(`Mean: ${data.mean}`)),

                vl
                    .markText({align: "center", baseline: "bottom", dx: 0, dy: -5})
                    .encode(vl.x().datum(data.median), vl.y().value(0), vl.text().value("Median")),

                vl
                    .markText({align: "center", baseline: "bottom", dx: 20, dy: 15})
                    .encode(vl.x().datum(data.mean), vl.y().value(0), vl.text().value("Mean"))
            )
            .render()
            .then((viewElement) => {
                // render returns a promise to a DOM element containing the chart
                // viewElement.value contains the Vega View object instance
                document.getElementById(elementId).appendChild(viewElement);
            });
    }

    // setup API options
    const vegaGrnaHistogramOptions = {
        config: {
            // Vega-Lite default configuration
        },
        init: (view) => {
            // initialize tooltip handler
            view.tooltip(new vegaTooltip.Handler().call);
        },
    };

    // register vega and vega-lite with the API
    vl.register(vega, vegaLite, vegaGrnaHistogramOptions);

    // now you can use the API!
    fetch("{% get_static_prefix %}search/experiments/{{ experiment.accession_id }}/g_per_c.pd")
        .then((response) => {
            if (!response.ok && response.status == 404) {
                return; // This is often okay and expected, not every analysis has this data
            }

            if(!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            return new Promise((resolve, reject) => resolve(response.arrayBuffer()))
                .then((buffer) => processHistogramData(buffer))
                .then((data) =>
                    createHistogramChart(data, "dimgray", "Number of gRNA per cell", "Number of gRNAs", "ngrna_histogram")
                )
                .catch((err) => console.log(err));
        })
        .catch((err) => console.log(err));

    // setup API options
    const vegaQqPlotOptions = {
        config: {
            // Vega-Lite default configuration
        },
        init: (view) => {
            // initialize tooltip handler
            view.tooltip(new vegaTooltip.Handler().call);
        },
    };

    // register vega and vega-lite with the API
    vl.register(vega, vegaLite, vegaQqPlotOptions);

    // now you can use the API!

    const fetchQQUrl = `{% get_static_prefix %}search/experiments/{{ experiment.accession_id }}/{{ analysis_selected }}/qqplot.pd`;
    fetch(fetchQQUrl)
        .then((response) => {
                if (!response.ok && response.status == 404) {
                    return; // This is often okay and expected, not every analysis has this data
                }

                if(!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                return new Promise((resolve, reject) => resolve(response.arrayBuffer()))
                .then((buffer) => {
                    // See scripts/data_generation/qc_plots/qq_plot.py in the source for an explanation
                    // of the data format.
                    let data = new DataView(buffer);
                    let decoder = new TextDecoder();
                    let offset = 0;
                    let values = [];
                    let quantileCount = data.getUint32(offset);
                    offset += 4;
                    let categoryCount = data.getUint8(offset);
                    offset += 1;
                    let categoryNames = [];
                    for(let i = 0; i < categoryCount; i++){
                        let nameSize = data.getUint8(offset);
                        offset += 1;
                        let nameArray = new Uint8Array(buffer, offset, nameSize);
                        let name = decoder.decode(nameArray);
                        offset += nameSize;
                        categoryNames.push(name)
                    }
                    let xLabelLen = data.getUint8(offset);
                    offset += 1;
                    let xLabelArray = new Uint8Array(buffer, offset, xLabelLen);
                    let xLabel = decoder.decode(xLabelArray);
                    offset += xLabelLen;
                    let yLabelLen = data.getUint8(offset);
                    offset += 1;
                    let yLabelArray = new Uint8Array(buffer, offset, yLabelLen);
                    let yLabel = decoder.decode(yLabelArray);
                    offset += yLabelLen;

                    for (let i = 0; i < quantileCount; i++) {
                        let x = data.getFloat32(offset);
                        offset += 4;
                        for(let j = 0; j < categoryCount; j++) {
                            let y = data.getFloat32(offset);
                            offset += 4;
                            values.push({t: x, o: y, cat: categoryNames[j]});
                        }
                    }

                    return {categoryNames, xLabel, yLabel, values};
                }).then((data) => {
                    let catColors = ['#5377A3', '#ff8c00', '#aec7e8', '#1f77b4', '#9467bd'];
                    const pValueScale = {
                        domain: [...data.categoryNames, "y = x"],
                        range: [...catColors.slice(0, data.categoryNames.length), "#ffcccc"]
                    };

                    let maxX = 0;
                    let maxY = 0;
                    for (let value of data.values) {
                        maxX = Math.max(value.t, maxX);
                        maxY = Math.max(value.o, maxY);
                    }

                    let max = Math.max(maxX, maxY);

                    let pValues = vl.markCircle({tooltip: true})
                    .data(data)
                    .encode(
                        vl.color().fieldN('cat').scale(pValueScale).title(''),
                        vl.x().fieldQ('t').title(data.xLabel),
                        vl.y().fieldQ('o').title(data.yLabel),
                    );

                    // Draw a faint red line where y = x
                    let xy = vl.markLine({clip: true})
                    .data([{x: 0, y: 0, cat: "y = x"}, {x: max, y: max, cat: "y = x"}])
                    .encode(
                        vl.color().fieldN('cat').scale(pValueScale),
                        vl.x().fieldQ('x').scale({domain: [0, maxX]}),
                        vl.y().fieldQ('y').scale({domain: [0, maxY]})
                    );

                    let plot = vl.layer(xy, pValues)
                    .width(450)
                    .height(400)
                    .title('Q-Q Plot')
                    .render();

                    return plot;
                }).then((viewElement) => {
                    // render returns a promise to a DOM element containing the chart
                    // viewElement.value contains the Vega View object instance
                    document.getElementById("uniform_qqplot").appendChild(viewElement);
                })
                .catch((err) => console.log(err));
            })
            .catch((err) => console.log(err));

    // setup API options
    const vegaCellsHistogramOptions = {
        config: {
            // Vega-Lite default configuration
        },
        init: (view) => {
            // initialize tooltip handler
            view.tooltip(new vegaTooltip.Handler().call);
        },
    };

    // register vega and vega-lite with the API
    vl.register(vega, vegaLite, vegaCellsHistogramOptions);

    // now you can use the API!
    fetch("{% get_static_prefix %}search/experiments/{{ experiment.accession_id }}/c_per_g.pd")
        .then((response) => {
            if (!response.ok && response.status == 404) {
                return; // This is often okay and expected, not every analysis has this data
            }

            if(!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            return new Promise((resolve, reject) => resolve(response.arrayBuffer()))
                .then((buffer) => processHistogramData(buffer))
                .then((data) =>
                    createHistogramChart(data, "#4c7cac", "Number of cells per gRNA", "Number of Cells", "ncells_histogram")
                )
                .catch((err) => console.log(err));
        })
        .catch((err) => console.log(err));

    var analysisSelector = document.getElementById("analysisSelector");
    if (analysisSelector) {
        analysisSelector.addEventListener("change", function() {
            window.location.href = this.value;
        });
    }

</script>

<script>
    $(document).ready(function () {
        $("#dataFilesTable").DataTable({
            columns: [null, {orderable: false}, null, {orderable: false}, {orderable: false}],
            info: false,
            paging: false,
            searching: false,
        });
        $("#otherFilesTable").DataTable({
            columns: [null, {orderable: false}, {orderable: false}, null, {orderable: false}, {orderable: false}],
            info: false,
            paging: false,
            searching: false,
        });
    });
</script>

<script type="module">
    import {exp_viz} from "{% static 'search/js/exp_viz/exp_viz.js' %}";
    exp_viz("{% get_static_prefix %}", "{{ experiment.accession_id }}", "{{ analysis_selected }}", "{{ csrf_token }}", "{{ experiment.get_source_type_display }}", "{{ logged_in }}" == "True");
</script>

<script src="{% static 'js/tw-elements/index.min.js' %}"></script>

<script>
    function closeModal() {
        let modal = document.getElementById("exp-modal");
        modal.classList.add("closing") // Kicks off an animation on the modal dialog
        modal.addEventListener("animationend", (event) => {
            modal.remove(); // remove the dialog from the DOM once the animation is over
        })
    }
</script>
{% endblock %}
