{% extends "base.html" %}
{% load static i18n %}
{% block title %}{{ region_type_name }}{% endblock %}
{% block css %}
{{ block.super }}
<link href="{% static 'genoverse/css/tooltips.css' %}" rel="stylesheet" ></link>
{% endblock %}
{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
<script type="text/javascript" src="{% static 'genoverse/js/genoverse.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/index.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/genoverse.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/state.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="text-2xl font-bold">{{ region_type_name }}</div>
    <div>
        <div>
            <div class="p-2" id="genoverse"></div>
            <div class="text-xl font-bold">Sites</div>
            {% include "search/v1/partials/_dnaregion.html" with regions=regions %}
            <div id="region_pagination" class="pagination">
                <span class="step-links">
                    {% if regions.has_previous %}
                        <a href="?page=1">&laquo; first</a>
                        <a href="?page={{ regions.previous_page_number }}">previous</a>
                    {% endif %}

                    <span class="current">
                        Page {{ regions.number }} of {{ regions.paginator.num_pages }}
                    </span>

                    {% if regions.has_next %}
                        <a href="?page={{ regions.next_page_number }}">next</a>
                        <a href="?page={{ regions.paginator.num_pages }}">last &raquo;</a>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
{% endblock %}

{% block inline_javascript %}
    <script>
        window.addEventListener("hashchange", _.throttle(function() {
            let hash = window.location.hash;
            [_, chromo, start, end] = hash.match(/^#r\=(\d+):(\d+)-(\d+)$/, '')

            fetch(`/search/regionloc/chr${chromo}/${start}/${end}?search_type=overlap&accept=application/json&{{ region_type_query_slug }}`)
                .then(response => {
                    return response.json()
                })
                .then(data => {
                    document.getElementById("dnaregion").replaceWith(regionTable(data["regions"], "No {{ region_type_name }}"));
                    document.getElementById("region_pagination").replaceWith(newPagination("region_pagination", data));
                });

        }, 500, { 'leading': true }));

        new CEGSGenoverse({
            container : '#genoverse', // Where to inject Genoverse (css/jQuery selector/DOM element)
            // If no genome supplied, it must have at least chromosomeSize, e.g.:
            // chromosomeSize : 249250621, // chromosome 1, human
            genome    : 'GRCh37', // see js/genomes/
            assembly  : 'GRCh37',
            chr       : "{{ loc.chr }}".replace("chr", ""),
            start     : {{ loc.start }},
            end       : {{ loc.end }},
            plugins   : [[ 'karyotype', { showAssembly: true }], 'trackControls', 'tooltips' ],
            useHash   : true,
            hideEmptyTracks: false,
            tracks    : [
                Genoverse.Track.Scaleline.extend({ strand: false }),
                Genoverse.Track.Scalebar,
                Genoverse.Track.DHS.Effects.extend({children: [Genoverse.Track.Gene.extend({ legend: false })]}),
            ]
        });
    </script>
{% endblock %}
