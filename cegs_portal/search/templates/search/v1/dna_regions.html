{% extends "base.html" %}
{% load static i18n %}
{% block title %}{{ region_type_name }}{% endblock %}
{% block css %}
{{ block.super }}
<link href="{% static 'genoverse/css/tooltips.css' %}" rel="stylesheet" ></link>
{% endblock %}
{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
<script type="text/javascript" src="{% static 'genoverse/js/genoverse.min.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/genoverse.js' %}"></script>
<script type="text/javascript" src="{% static 'search/js/state.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="text-2xl font-bold">{{ region_type_name }}</div>
    <div>
        <div>
            <div class="p-2" id="genoverse"></div>
            <div class="text-xl font-bold">Sites</div>
            {% include "search/v1/partials/_dnaregion.html" with regions=regions %}
            <div id="dhs_pagination" class="pagination">
                <span class="step-links">
                    {% if regions.has_previous %}
                        <a id="dhs_first_link" href="?page=1">&laquo; first</a>
                        <a id="dhs_prev_link" href="?page={{ regions.previous_page_number }}">previous</a>
                    {% endif %}

                    <span class="current">
                        Page {{ regions.number }} of {{ regions.paginator.num_pages }}
                    </span>

                    {% if regions.has_next %}
                        <a id="dhs_next_link" href="?page={{ regions.next_page_number }}">next</a>
                        <a id="dhs_last_link" href="?page={{ regions.paginator.num_pages }}">last &raquo;</a>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
{% endblock %}

{% block inline_javascript %}
    <script type="module">
        import { dataPages, regionTable, emptyRegionTable, pageLink } from "{% static 'search/js/tables.js' %}"

        const STATE_LOCATION = "location";
        let state = new State([STATE_LOCATION]);
        state.updateSharedState(STATE_LOCATION, {
            chr: "{{ loc.chr }}",
            start: {{ loc.start }},
            end: {{ loc.end }}
        }
        );

        // Update the chromosome location at the top of the page
        state.addCallback(STATE_LOCATION, (state, key) => {
            let location = state[key];
            genDataPages(location.chr, location.start, location.end, 1)();
        });

        const _ul = function(_state, key) {
            if (key !== STATE_LOCATION) { return; }
            state.updateSharedState(key, _state[key]);
        };

        let initialLocation = state.getSharedState(STATE_LOCATION);

        let regionURL = function(chromosome, start, end) {
            return `/search/regionloc/chr${chromosome}/${start}/${end}?search_type=overlap&accept=application/json&region_type=dhs`;
        }

        let genDataPages = function(chromo, start, end, page) {
            return dataPages(
                page,
                _ => regionURL(chromo, start, end),
                regionTable,
                emptyRegionTable,
                region => true,
                "No DHSs Found",
                "dnaregion",
                "dhs_pagination",
                "dhs",
                "page"
            );
        }

        let getPages = genDataPages(initialLocation.chr, initialLocation.start, initialLocation.end, 1);

        {% if regions.has_previous %}
        pageLink("dhs_first_link", 1, getPages);
        pageLink("dhs_prev_link", {{ regions.previous_page_number }}, getPages);
        {% endif %}
        {% if regions.has_next %}
        pageLink("dhs_next_link", {{ regions.next_page_number }}, getPages);
        pageLink("dhs_last_link", {{ regions.paginator.num_pages }}, getPages);
        {% endif %}

        new CEGSGenoverse({
            container : '#genoverse', // Where to inject Genoverse (css/jQuery selector/DOM element)
            // If no genome supplied, it must have at least chromosomeSize, e.g.:
            // chromosomeSize : 249250621, // chromosome 1, human
            genome    : 'GRCh37', // see js/genomes/
            assembly  : 'GRCh37',
            chr       : "{{ loc.chr }}".replace("chr", ""),
            start     : {{ loc.start }},
            end       : {{ loc.end }},
            plugins   : [[ 'karyotype', { showAssembly: true }], 'trackControls', 'tooltips' ],
            useHash   : true,
            hideEmptyTracks: false,
            sharedStateCallbacks: [_ul],
            tracks    : [
                Genoverse.Track.Scaleline.extend({ strand: false }),
                Genoverse.Track.Scalebar,
                Genoverse.Track.DHS.Effects.extend({children: [Genoverse.Track.Gene.extend({ legend: false })]}),
            ]
        });
    </script>
{% endblock %}
